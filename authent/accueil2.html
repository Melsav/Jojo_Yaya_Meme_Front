<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SkyMétéo - Votre Prévision Météo Fiable</title>
    <link rel="stylesheet" href="style_accueil2.css">
</head>
<body>


<div class="popup" id="popup">
  <div class="popup-encart"></div>
  <div class="popup-contenu" id="popup-contenu">Il fait froid à Paris (9 °C). Sortez vos manteaux!<br/><a href="#" id="popup-fermeture">Fermer</a></div>
</div>

    <header>
        <div class="logo">
            <img id="logo_site" src="LOGOO-removebg-preview.png" alt="Logo SkyMétéo">
            <span class="site-name">SkyMétéo</span>
        </div>
        <nav>
            <ul class="nav_links">
                <li><a href="accueil2.html">Accueil</a></li>
                <li><a href="../weather/prevision_meteo.html">Prévisions</a></li>
                <li><a href="../spaces/home.html">Météo Spatiale</a></li>
                <li><a href="../weather/map.html">Map</a></li>
                <li><a href="favoris.html">Favoris</a></li>
                <li><a href="profil.html">Profil</a></li>

            </ul>
        </nav>
        
    </header>
    <div class="weather-widgets">
    <div id="openweathermap-widget-1"></div>
    <div id="openweathermap-widget-2"></div>
    <div id="openweathermap-widget-3"></div>
    <div id="openweathermap-widget-4"></div>
    <div id="openweathermap-widget-5"></div>
    <div id="openweathermap-widget-13"></div>
    <div id="openweathermap-widget-14"></div>
    <div id="openweathermap-widget-15"></div>
    <div id="openweathermap-widget-16"></div>
    <div id="openweathermap-widget-6"></div>
</div>
<script>function setupWeatherWidget(id, cityId, containerId) {
    window.myWidgetParam = window.myWidgetParam || [];
    window.myWidgetParam.push({
        id: id,
        cityid: cityId,
        appid: '59ed57b0e3ce0bc0b9ebc3cfe7558c94',
        units: 'metric',
        containerid: containerId,
       
    });


    if (!document.querySelector('.weather-widget-script')) {
        const script = document.createElement('script');
        script.className = 'weather-widget-script'; 
        script.async = true;
        script.charset = "utf-8";
        script.src = "//openweathermap.org/themes/openweathermap/assets/vendor/owm/js/weather-widget-generator.js";
        document.head.appendChild(script);
        console.log("nee");
    }
}


document.addEventListener('DOMContentLoaded', () => {
    setupWeatherWidget(14, '2995468', 'openweathermap-widget-1'); // Marseille
    setupWeatherWidget(14, '2996943', 'openweathermap-widget-2'); // Lyon
    setupWeatherWidget(14, '2990439', 'openweathermap-widget-3'); // Nice
    setupWeatherWidget(14, '3031582', 'openweathermap-widget-4'); // Bordeaux
    setupWeatherWidget(14, '2972315', 'openweathermap-widget-13'); // Toulouse
    setupWeatherWidget(14, '2990968', 'openweathermap-widget-14'); // Nantes
  
    setupWeatherWidget(14, '2972328', 'openweathermap-widget-15'); // reste a definir
    setupWeatherWidget(14, '2998324', 'openweathermap-widget-16'); // reste a definir
    setupWeatherWidget(14, '2994160', 'openweathermap-widget-6'); // reste a definir
    
    
    
});
</script>
   
    <div class="feedback-section">
        <h2>Envoyez-nous vos commentaires</h2>
        <form id="feedback-form">
            <input type="text" id="comment" name="comment" placeholder="Commentaire" required>
            <button id="btn" type="submit">Envoyer</button>
        </form>
    </div>
    <footer>
        <p>&copy; 2024 SkyMeteo. Tous droits réservés. | <a href="#">Politique de confidentialité</a> | <a href="#">Termes et conditions</a></p>
    </footer>


    <script>


        const apiUrl = "http://localhost:3000";
        const apiKey = "b02d002425ab7d06a6fdc8fe45e6e459";
        
        
        document.addEventListener('DOMContentLoaded', function() {
    var popupAlreadyShowed = false;
    console.log(popupAlreadyShowed);

    const userId = localStorage.getItem("userId");
    const userType = localStorage.getItem("userType");
    const formData = JSON.stringify({ userId: userId, userType: userType });
    console.log(formData);
    // Fetch city and country based on user ID

    fetch(`http://localhost:3000/cityCountry`, {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${localStorage.getItem("jwtToken")}`},
        body: formData
    })
    .then(response => {
        if (!response.ok) {
          //   throw new Error('Réponse non valide du backend');
        }
        return response.json();
    })
    .then(data => {
        const yourCity = data.city;
        const yourCountry = data.country;

        // Fetch weather data based on user's city and country
        return fetch(`${apiUrl}/api/getFilteredWeather?country=${yourCity}&city=${yourCountry}`);
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Réponse non valide du backend');
        }
        return response.json();
    })
    .then(weatherData => {
        console.log(weatherData);
        // Display weather information
        displayWeatherInfo(weatherData, yourCity);
    })
    .catch(error => {
        console.error('Error:', error);
    });

    function displayWeatherInfo(data, locationName) {
        const temperature = data.main.temp;
        let weatherInfo;

        if (temperature < 10) {
            weatherInfo = `Il fait froid à ${locationName} (${temperature} °C). Sortez vos manteaux!`;
        } else if (temperature >= 10 && temperature <= 20) {
            weatherInfo = `La température à ${locationName} est agréable (${temperature} °C). Profitez-en!`;
        } else {
            weatherInfo = `Il fait chaud à ${locationName} (${temperature} °C). Restez au frais!`;
        }
        document.getElementById('popup-contenu').textContent = weatherInfo;

        // Show the popup after fetching and displaying weather information
        
    }
    if (!popupAlreadyShowed) {
            setTimeout(function() {
                document.getElementById('popup').style.display = 'block';
                popupAlreadyShowed = true;
            }, 2000); // 2000 milliseconds (2 seconds) delay before showing the popup
        }
});

document.getElementById('popup-fermeture').addEventListener('click', function(e) {
  document.getElementById('popup').style.display = 'none'
})




    
            // Écouter les changements dans la liste déroulante des pays
            countrySelect.addEventListener('change', function() {
                const selectedCountry = countrySelect.value;
                citySelect.innerHTML = '';
    
                // Récupérer la liste des villes pour le pays sélectionné depuis votre serveur back-end
                fetch(`${apiUrl}/api/getCities?country=${selectedCountry}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(city => {
                            const option = document.createElement('option');
                            option.value = city;
                            option.textContent = city;
                            citySelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error('Error fetching cities:', error);
                    });
            });
        
        
        
        function fetchEvents(fetchInfo, successCallback, failureCallback) {
            const start = fetchInfo.start.toISOString();
            const end = fetchInfo.end.toISOString();
            const selectedCountry = document.getElementById('country').value;
            const selectedCity = document.getElementById('city').value;
    
            // Récupérer les données météorologiques filtrées depuis votre serveur back-end
            fetch(`${apiUrl}/api/getFilteredWeather?country=${selectedCountry}&city=${selectedCity}`)
                .then(response => response.json())
                .then(data => {
                    const events = [{
                        title: `Météo pour ${data.name}: ${data.weather[0].description}`,
                        start: new Date(),
                        color: data.main.temp > 20 ? 'red' : 'blue'
                    }];
                    successCallback(events);
                })
                .catch(error => {
                    console.error('Error fetching weather data:', error);
                    failureCallback(error);
                });
        }
    
        document.getElementById('filterBtn').addEventListener('click', function() {
            calendar.refetchEvents();
        });
    
        document.addEventListener('DOMContentLoaded', function() {
            fetch(`${apiUrl}/getWeather`)
                .then(response => response.json())
                .then(data => {
                    if (data) {
                        showWeatherPopup(data);
                    }
                })
                .catch(error => console.error('Error fetching weather:', error));
        });
    
        function showWeatherPopup(weatherData) {
            const popupContent = `
                <strong>Météo pour ${weatherData.name}:</strong>
                <p>Température: ${weatherData.main.temp} °C</p>
                <p>Condition: ${weatherData.weather[0].description}</p>
                <p>Humidité: ${weatherData.main.humidity}%</p>
                <p>Vent: ${weatherData.wind.speed} km/h</p>
            `;
            alert(popupContent); // ou utilisez une modal personnalisée pour un meilleur style
        }

        let popupAlreadyShowed = false

        window.addEventListener('mousemove', function(e) {
        if( ! popupAlreadyShowed ) {
            setTimeout( () => {
            document.getElementById('popup').style.display = 'block'
            }, 3000 )
            popupAlreadyShowed = true
        }
        });

        document.getElementById("feedback-form").addEventListener("submit", function(event) {
    event.preventDefault();

    if(localStorage.getItem("userId")){userId = localStorage.getItem("userId")}
    else{userId = 0}
    const formData = {
        comment: document.getElementById("comment").value,
        id: userId
    };

    // Vérifiez si les champs sont tous remplis
    if (!comment) {
        alert('Veuillez remplir tous les champs requis.');
        return;}

        fetch('http://localhost:3000/commentary', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        console.log('Success:', data);
        alert('Commentaire envoyé avec succès.');
        document.getElementById("feedback-form").reset();
    })
    .catch((error) => {
        console.error('Error:', error);
        alert('Une erreur est survenue lors de l\'envoie.');
    });
});
    </script>
</body>
</html>

